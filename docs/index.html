<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Veille Le Bateau Jaune ‚Äì Philippe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/css/style.css">
	<link rel="stylesheet" href="../assets/css/legal.css">
</head>

<body>

<header>
    <img src="img/Logo_LBJ-13A.png" alt="Logo Le Bateau Jaune" class="logo">
    <div class="title-block">
        <h1>Veille r√©glementaire, p√©dagogique et m√©tiers</h1>
        <p>Agr√©gateur</p>
    </div>
</header>

<nav class="top-menu">
    <div class="nav-left">
        <a href="../index.html">Accueil</a>
        <a href="../legal/legal.html" class="active">R√©f√©rences L√©gales</a>
    </div>

    <div class="nav-center">
        <input type="text" id="legal-search" placeholder="Rechercher‚Ä¶" />
    </div>

    <div class="nav-right">
		<span id="pipeline-status" class="pipeline-badge">Chargement‚Ä¶</span>
	</div>
</nav>



<div class="layout">

    <!-- COLONNE GAUCHE -->
    <div class="main-column">

        <!-- Veille l√©gale -->
        <details class="section-block" open>
            <summary>Veille l√©gale & r√©glementaire</summary>

            <div class="flux-consolidated">
                <a href="xml/flux_legal.xml" target="_blank">flux_legal.xml</a>
            </div>

            <!-- SOURCES EXTERNES -->
            <div id="legal-service-public"></div>
            <div id="legal-travail"></div>
            <div id="legal-economie"></div>

            <!-- Flux consolid√© -->
            <div id="articles-legal"></div>
        </details>

        <!-- Veille p√©dagogique -->
        <details class="section-block">
            <summary>Veille p√©dagogique & technologique</summary>

            <div class="flux-consolidated">
                <a href="xml/flux_pedago.xml" target="_blank">flux_pedago.xml</a>
            </div>

            <!-- SOURCES EXTERNES -->
            <div id="pedago-digiforma"></div>

            <!-- Flux consolid√© -->
            <div id="articles-pedago"></div>
        </details>

        <!-- Veille m√©tiers -->
        <details class="section-block">
            <summary>√âvolution m√©tiers & comp√©tences (Sport / Plong√©e)</summary>

            <div class="flux-consolidated">
                <a href="xml/flux_metiers.xml" target="_blank">flux_metiers.xml</a>
            </div>

            <!-- SOURCES EXTERNES -->
            <div id="metiers-injep"></div>
            <div id="metiers-ffessm"></div>

            <!-- Flux consolid√© -->
            <div id="articles-metiers"></div>
        </details>

    </div>

    <!-- COLONNE DROITE -->
	<aside class="sidebar">

		<!-- Bloc 1 : Activit√© r√©cente -->
		<div class="sidebar-block">
			<h3><span class="icon">üìä</span> Activit√© r√©cente</h3>
			<div class="activity-controls">
				<label>Affichage :</label>
				<select id="activityMode">
					<option value="day" selected>Jour</option>
					<option value="week">Semaine</option>
					<option value="month">Mois</option>
				</select>

				<label>P√©riode :</label>
				<select id="activityRange">
					<option value="7">7 jours</option>
					<option value="30" selected>30 jours</option>
					<option value="90">90 jours</option>
					<option value="all">Tout</option>
				</select>
			</div>
			<canvas id="activityChart" width="300" height="200"></canvas>
		</div>

		<!-- Bloc 2 : Mises √† jour -->
		<div class="sidebar-block">
			<h3><span class="icon">‚è±Ô∏è</span> Mises √† jour</h3>
			<div id="pipeline-status-box" class="update-box"></div>

			<div id="update-history" class="update-history"></div>
			<a href="xml/update_history.log" target="_blank" class="history-link">Voir le log complet</a>
			<a href="../dashboard.html" target="_blank" class="history-link">Dashboard COSMOS</a>
			<a href="../xml/logs.jsonl" target="_blank" class="history-link">Logs</a>
		</div>

		<!-- Bloc 3 : Derniers articles -->
		<div class="sidebar-block">
			<h3><span class="icon">üì∞</span> Derniers articles</h3>
			<div id="articles-global"></div>
		</div>

	</aside>

</div>

<footer>
    Agr√©gateur RSS ‚Äì Philippe ‚Äì Le Bateau Jaune - Propuls√© par Python & o2switch
</footer>

<!-- Scripts dans le bon ordre -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="assets/js/feeds-local.js"></script>
<script src="assets/js/feeds-external.js"></script>
<script src="assets/js/activity-chart.js"></script>
<script src="assets/js/main.js"></script>

<!-- SCRIPT PIPELINE + MINI LOG -->
<script>
/* --- BADGE TOP-MENU + STATUT PIPELINE --- */
fetch("xml/last_update.json")
  .then(r => r.json())
  .then(data => {
    const date = new Date(data.last_update);
    const formatted = date.toLocaleString("fr-FR");

    // Badge top-menu
    const badge = document.getElementById("pipeline-status");
    badge.textContent = "üü¢ Mise √† jour : " + formatted;
    badge.classList.add("pipeline-ok");

    // Encadr√© sidebar
    document.getElementById("pipeline-status-box").innerHTML =
      `<div class="pipeline-ok-box">
         üü¢ Mise √† jour OK<br>
         Derni√®re mise √† jour : <strong>${formatted}</strong>
       </div>`;
  })
  .catch(() => {
    const badge = document.getElementById("pipeline-status");
    badge.textContent = "üî¥ Echec de la mise √† jour";
    badge.classList.add("pipeline-ko");

    document.getElementById("pipeline-status-box").innerHTML =
      `<div class="pipeline-ko-box">
         üî¥ Echec de la mise √† jour<br>
         Impossible de lire last_update.json
       </div>`;
  });

/* --- MINI LOG DES MISES √Ä JOUR --- */
fetch("xml/update_history.log")
  .then(r => r.text())
  .then(text => {
	/* --- MINI LOG DES MISES √Ä JOUR --- */
	fetch("xml/update_history.log")
	.then(r => r.text())
	.then(text => {
		const lines = text.trim().split("\n").slice(-3).reverse();
		document.getElementById("update-history").innerHTML =
		"<ul>" + lines.map(l => `<li>${l}</li>`).join("") + "</ul>";
	})
	.catch(() => {
		document.getElementById("update-history").innerHTML =
		"<em>Historique indisponible</em>";
	});
    document.getElementById("update-history").innerHTML =
      "<ul>" + lines.map(l => `<li>${l}</li>`).join("") + "</ul>";
  })
  .catch(() => {
    document.getElementById("update-history").innerHTML =
      "<em>Historique indisponible</em>";
  });
</script>

</body>
</html>